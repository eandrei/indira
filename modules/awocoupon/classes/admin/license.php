<?php
/**
 * @component AwoCoupon Pro
 * @copyright Copyright (C) Seyi Awofadeju - All rights reserved.
 * @Website : http://awodev.com
 *
 */

class AwoCouponModelLicense {var $_errors;function __construct() {$this->awocoupon = new AwoCoupon();$this->_data = null;$this->m_url = 'http://awodev.com/sites/default/files/license';}function getData(){if (empty($this->_data)) {$this->_data = $myawo = $this->getlocalkey();if (!empty($this->_data->websites)) $this->_data->website = current($this->_data->websites);if (empty($this->_data->license) && empty($this->_data->local_key)) $this->_data->website = strtolower($this->parse_url_domain('http://'.$_SERVER['HTTP_HOST'].__PS_BASE_URI__));if (!eval($this->_data->evaluation)) {$this->_data->ispermanent = 'no';}}return $this->_data;}function check(){$myawo = $this->getlocalkey();if (empty($myawo->local_license)) {$this->_errors[] = $this->awocoupon->l('Please activate license');return false;}if ($myawo->ispermanent == 'no' && $myawo->expiration < time()) {$url = $this->m_url . '/renew.php';$get = array('license' => $myawo->license,);if (!($data = $this->remoteconnect($url, $get))) {$this->_errors[] = $this->awocoupon->l('Could not connect to validation server');return false;}if ($data == '-1') {$this->_errors[] = $this->awocoupon->l('Data does not match');return false;}return $this->update_localkey($myawo->license, $data);}return true;}function activate(){$post = awoHelper::getValues($_POST);if (empty($post['website'])) {$this->_errors[] = $this->awocoupon->l('Website: please enter an input');return false;}if (empty($post['license'])) {$this->_errors[] = $this->awocoupon->l('License: please enter an input');return false;}$tmp = awoHelper::loadResult('SELECT id FROM '._DB_PREFIX_.'awocoupon_license WHERE id="license"');if (empty($tmp)) $sql = 'INSERT INTO '._DB_PREFIX_.'awocoupon_license (id,value) VALUES ("license","' . $post['license'] . '")';else $sql = 'UPDATE '._DB_PREFIX_.'awocoupon_license SET value="' . $post['license'] . '" WHERE id="license"';awoHelper::query($sql);$url = $this->m_url . '/activate.php';$get = array('activationcode' => $post['license'],'host' => $post['website'],);if (!($data = $this->remoteconnect($url, $get))) {$this->_errors[] = $this->awocoupon->l('Could not connect to validation server');return false;}if ($data == '-1') {$this->_errors[] = $this->awocoupon->l('Data does not match');return false;}return $this->update_localkey($post['license'],$data);}function getlocalkey(){$myawo = null;$myawo = (object)array();$myawo->license = '';$myawo->local_license = '';$myawo->local_key = '';$myawo->website = '';$myawo->websites = '';$myawo->ispermanent = '';$myawo->expiration = '';$myawo->evaluation = '';$myawo->is_valid = false;$rows = awoHelper::loadObjectList('SELECT id,value FROM '._DB_PREFIX_.'awocoupon_license');if (!empty($rows)) {foreach($rows as $row) {if ($row->id == 'license') $myawo->license = $row->value;elseif ($row->id == 'local_key') {$myawo->local_key = $row->value;$tmp = $this->_unwrap_vpass($row->value);if (is_array($tmp)) {@$myawo->local_license = $tmp['license'];@$myawo->websites = $tmp['host'];@$myawo->ispermanent = $tmp['ispermanent'];@$myawo->expiration = $tmp['expiration'];@$myawo->evaluation = $tmp['eval'];}}}}return $myawo;}function update_localkey($license, $data){if (empty($license)) {$this->_errors[] = $this->awocoupon->l('License: please enter an input');return false;}if (empty($data)) {$this->_errors[] = $this->awocoupon->l('Local key: please enter an input');return false;}$website = $expiration = '';$tmp = $this->_unwrap_vpass($data);if (is_array($tmp)) {@$website = $tmp['host'];@$expiration = $tmp['expiration'];}if (empty($website)) {$this->_errors[] = $this->awocoupon->l('Website: please enter an input');return false;}$tmp = awoHelper::loadResult('SELECT id FROM '._DB_PREFIX_.'awocoupon_license WHERE id="license"');if (empty($tmp)) $sql = 'INSERT INTO '._DB_PREFIX_.'awocoupon_license (id,value) VALUES ("license","' . $license . '")';else $sql = 'UPDATE '._DB_PREFIX_.'awocoupon_license SET value="' . $license . '" WHERE id="license"';awoHelper::query($sql);$tmp = awoHelper::loadResult('SELECT id FROM '._DB_PREFIX_.'awocoupon_license WHERE id="local_key"');if (empty($tmp)) $sql = 'INSERT INTO '._DB_PREFIX_.'awocoupon_license (id,value) VALUES ("local_key","' . $data . '")';else $sql = 'UPDATE '._DB_PREFIX_.'awocoupon_license SET value="' . $data . '" WHERE id="local_key"';awoHelper::query($sql);$tmp = awoHelper::loadResult('SELECT id FROM '._DB_PREFIX_.'awocoupon_license WHERE id="website"');if (empty($tmp)) $sql = 'INSERT INTO '._DB_PREFIX_.'awocoupon_license (id,value) VALUES ("website","' . implode('|', $website) . '")';else $sql = 'UPDATE '._DB_PREFIX_.'awocoupon_license SET value="' . implode('|', $website) . '" WHERE id="website"';awoHelper::query($sql);$tmp = awoHelper::loadResult('SELECT id FROM '._DB_PREFIX_.'awocoupon_license WHERE id="expiration"');if (empty($tmp)) $sql = 'INSERT INTO '._DB_PREFIX_.'awocoupon_license (id,value) VALUES ("expiration","' . $expiration . '")';else $sql = 'UPDATE '._DB_PREFIX_.'awocoupon_license SET value="' . $expiration . '" WHERE id="expiration"';awoHelper::query($sql);return true;}function uninstall(){awoHelper::query('DELETE FROM '._DB_PREFIX_.'awocoupon_license');return true;}function remoteconnect($url, $request = array()){$data = '';$data = $this->curl_get($url, $request);if (!empty($data)) return $data;$data = $this->fsockopen_get($url, $request);if (!empty($data)) return $data;return false;}function curl_get($url, $request = array() , $options = array()){if (!function_exists('curl_init') || !function_exists('curl_exec')) return;$request_string = '';if (!empty($request)) {foreach($request as $k => $v) $request_string.= $k . '=' . urlencode($v) . '&';$request_string = substr($request_string, 0, -1);}$defaults = array(CURLOPT_URL => $url,CURLOPT_POST => count($request) ,CURLOPT_POSTFIELDS => $request_string,CURLOPT_HEADER => 0,CURLOPT_RETURNTRANSFER => TRUE,CURLOPT_TIMEOUT => 5,);$ch = curl_init();curl_setopt_array($ch, ($options + $defaults));if (!$result = curl_exec($ch)) {trigger_error(curl_error($ch));}curl_close($ch);return $result;}function _unwrap_vpass($text){$text = substr($text, (strpos($text, "\n") + 1));$text = substr($text, 0, strrpos($text, "\n"));$str = trim(str_replace(array("\r","\n","\t") , '', $text));$rand_add_on = substr($str, 0, 3);$str = base64_decode(base64_decode(substr($str, 3)));$rc = 're@achuFr?Se7heBrAgasputhapras?apAbe8e2ux8w6we+@th=TraVuw!#!$humUn&jap-sPe9eTeQ5Pra@A4r#pRustuyubR!mum*je&r5re2ru2u22th';$rc = $rand_add_on . $rc;$unwrapped = '';for ($i = 1; $i <= strlen($str); $i++) {$char = substr($str, $i - 1, 1);$keychar = substr($rc, ($i % strlen($rc)) - 1, 1);$char = chr(ord($char) - ord($keychar));$unwrapped.= $char;}return unserialize($unwrapped);}function fsockopen_get($url, $request = array() , $options = array()){if (!function_exists('fsockopen')) return;$request_string = '';if (!empty($request)) {foreach($request as $k => $v) $request_string.= $k . '=' . urlencode($v) . '&';$request_string = substr($request_string, 0, -1);}$parse_url = parse_url($url);$errno = 0;$errstr = '';$fsock = @fsockopen($parse_url['host'], !empty($parse_url['port']) ? $parse_url['port'] : 80, $errno, $errstr, 5);if (!$fsock) return;@fputs($fsock, 'POST ' . $parse_url['path'] . " HTTP/1.1\r\n");@fputs($fsock, 'HOST: ' . $parse_url['host'] . "\r\n");@fputs($fsock, "Content-type: application/x-www-form-urlencoded\r\n");@fputs($fsock, "Content-length: " . strlen($request_string) . "\r\n");@fputs($fsock, "Connection: close\r\n\r\n");@fputs($fsock, $request_string . "\r\n\r\n");@stream_set_blocking($fsock, 1);@stream_set_timeout($fsock, 5);$data = '';$get_info = false;while (!@feof($fsock)) {if ($get_info) {$data.= @fread($fsock, 1024);}else {if (@fgets($fsock, 1024) == "\r\n") {$get_info = true;}}}@fclose($fsock);return $data;}function parse_url_domain($url){$raw_url = parse_url($url);$myhost = strtolower($raw_url['host'] . '/' . trim($raw_url['path'], '/'));$myhost = trim($myhost, '/');return $myhost;}}
